<section id="user" class="ver2">
    <div class="location">
        <i class="fa-light fa-house-blank"></i> 홈 <i class="fa-light fa-angle-right"></i> <strong>의약품</strong>
    </div>
    <div class="inr flex js">
        <section>
            <h6>최근 주문
                <button type="button" class="btn" id="listOpen1">접기</button>
            </h6>
            <div class="w100"><!--임시-->
				<div class="flex js sub" id="drugs_list_recent">
					<span class="flex gap10 ai-c w100">
						<strong>주문일 <b class="txt_blue">24.10.17</b></strong>
						<button type="button" class="btn male-auto btn_blueline">전체 담기</button>
					</span>
				</div>
				<div class="drugs_list my_list">
					<ul>
						<li>
							<div class="flex">
								<input type="checkbox" name="checkIdx" id="checkIdx_recent1" value="1" class="">
								<label for="checkIdx_recent1">
									<div>
										<p class="p_name">
											라식스주사20mg/2ml
										</p>
										<span>제조사 <strong>(주)한독</strong> |</span>
										<span>단위 <strong>2 mL/50A</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>furosemide   20mg(10mg/mL)</strong> |</span>
										<span>재고수량  <strong>0</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price" style="display: none">17,450원</p>
										<p style="font-weight: 700;text-align: right;">17,450원</p>
									</div>
								</label>
							</div>
						</li>
						<li>
							<div class="flex">
								<input type="checkbox" name="checkIdx" id="checkIdx_recent2" value="2" class="">
								<label for="checkIdx_recent2">
									<div>
										<p class="p_name">
											파미틴정20mg                                            </p>
										<span>제조사 <strong>(주)씨엠지제약</strong> |</span>
										<span>단위 <strong>300T</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>famotidine 20mg</strong> |</span>
										<span>재고수량  <strong>8</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price" style="display: none">48,300원</p>
										<p style="font-weight: 700;text-align: right;">48,300원</p>
									</div>
								</label>
							</div>
						</li>
						<li>
							<div class="flex">
								<input type="checkbox" name="checkIdx" id="checkIdx_recent3" value="3" class="">
								<label for="checkIdx_recent3">
									<div>
										<p class="p_name">
											라노펜정325mg                                            </p>
										<span>제조사 <strong>한국코러스(주)</strong> |</span>
										<span>단위 <strong>30T</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>acetaminophen   0.325g</strong> |</span>
										<span>재고수량  <strong>63</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price" style="display: none">4,530원</p>
										<p style="font-weight: 700;text-align: right;">4,530원</p>
									</div>
								</label>
							</div>
						</li>
						<li>
							<div class="flex">
								<input type="checkbox" name="checkIdx" id="checkIdx_recent4" value="4" class="">
								<label for="checkIdx_recent4">
									<div>
										<p class="p_name">
											인테스캡슐200mg                                            </p>
										<span>제조사 <strong>(주)씨엠지제약</strong> |</span>
										<span>단위 <strong>600C</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>acetylcysteine   0.2g</strong> |</span>
										<span>재고수량  <strong>9</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price" style="display: none">29,400원</p>
										<p style="font-weight: 700;text-align: right;">29,400원</p>
									</div>
								</label>
							</div>
						</li>
						<li>
							<div class="flex">
								<input type="checkbox" name="checkIdx" id="checkIdx_recent5" value="5" class="">
								<label for="checkIdx_recent5">
									<div>
										<p class="p_name">
											탐스로진서방정0.2mg                                            </p>
										<span>제조사 <strong>익수제약(주)</strong> |</span>
										<span>단위 <strong>100T</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>tamsulosin hydrochloride   0.2</strong> |</span>
										<span>재고수량  <strong>30</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price" style="display: none">31,500원</p>
										<p style="font-weight: 700;text-align: right;">31,500원</p>
									</div>
								</label>
							</div>
						</li>
					</ul>
				</div>
				<div class="flex js sub" id="drugs_list_recent">
					<span class="flex gap10 ai-c w100">
						<strong>주문일 <b class="txt_blue">24.10.15</b></strong>
						<button type="button" class="btn male-auto btn_blueline">전체 담기</button>
					</span>
				</div>
				<div class="drugs_list my_list">
					<ul>
						<li>
							<div class="flex">
								<input type="checkbox" name="checkIdx" id="checkIdx_recent6" value="6" class="">
								<label for="checkIdx_recent6">
									<div>
										<p class="p_name">
											실크론지크림15g                                            </p>
										<span>제조사 <strong>동광제약(주)</strong> |</span>
										<span>단위 <strong>15 g/1개</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>betamethasone dipropionate   9</strong> |</span>
										<span>재고수량  <strong>0</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price" style="display: none">615원</p>
										<p style="font-weight: 700;text-align: right;">615원</p>
									</div>
								</label>
							</div>
						</li>
						<li>
							<div class="flex">
								<input type="checkbox" name="checkIdx" id="checkIdx_recent7" value="7" class="">
								<label for="checkIdx_recent7">
									<div>
										<p class="p_name">
											엔딕스크림15g                                            </p>
										<span>제조사 <strong>동광제약(주)</strong> |</span>
										<span>단위 <strong>15 g/1개</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>econazole nitrate   0.15g(10mg</strong> |</span>
										<span>재고수량  <strong>0</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price" style="display: none">705원</p>
										<p style="font-weight: 700;text-align: right;">705원</p>
									</div>
								</label>
							</div>
						</li>
						<li>
							<div class="flex">
								<input type="checkbox" name="checkIdx" id="checkIdx_recent8" value="8" class="">
								<label for="checkIdx_recent8">
									<div>
										<p class="p_name">
											케토크린플라스타30mg                                            </p>
										<span>제조사 <strong>신신제약(주)</strong> |</span>
										<span>단위 <strong>6매</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>ketoprofen(f.) 30mg</strong> |</span>
										<span>재고수량  <strong>0</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price" style="display: none">756원</p>
										<p style="font-weight: 700;text-align: right;">756원</p>
									</div>
								</label>
							</div>
						</li>
						<li>
							<div class="flex">
								<input type="checkbox" name="checkIdx" id="checkIdx_recent9" value="9" class="">
								<label for="checkIdx_recent9">
									<div>
										<p class="p_name">
											후메론점안액0.02%/5ml                                            </p>
										<span>제조사 <strong>한림제약(주)</strong> |</span>
										<span>단위 <strong>5 mL/1병</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>fluorometholone   1mg(0.2mg/mL</strong> |</span>
										<span>재고수량  <strong>0</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price" style="display: none">825원</p>
										<p style="font-weight: 700;text-align: right;">825원</p>
									</div>
								</label>
							</div>
						</li>
					</ul>
				</div>
				<div class="flex js sub" id="drugs_list_recent">
					<span class="flex gap10 ai-c w100">
						<strong>주문일 <b class="txt_blue">24.10.10</b></strong>
						<button type="button" class="btn male-auto btn_blueline">전체 담기</button>
					</span>
				</div>
				<div class="drugs_list my_list">
					<ul>
						<li>
							<div class="flex">
								<input type="checkbox" name="checkIdx" id="checkIdx_recent10" value="10" class="">
								<label for="checkIdx_recent10">
									<div>
										<p class="p_name">
											헥사메딘액0.12% 100ml                                            </p>
										<span>제조사 <strong>부광약품(주)</strong> |</span>
										<span>단위 <strong>100 mL/1병</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>chlorhexidine gluconate soluti</strong> |</span>
										<span>재고수량  <strong>0</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price" style="display: none">910원</p>
										<p style="font-weight: 700;text-align: right;">910원</p>
									</div>
								</label>
							</div>
						</li>
						<li>
							<div class="flex">
								<input type="checkbox" name="checkIdx" id="checkIdx_recent11" value="11" class="">
								<label for="checkIdx_recent11">
									<div>
										<p class="p_name">
											아시클로버크림500mg                                            </p>
										<span>제조사 <strong>고려제약(주)</strong> |</span>
										<span>단위 <strong>5 g/1개</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>acyclovir   0.25g(50mg/g)</strong> |</span>
										<span>재고수량  <strong>0</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price" style="display: none">914원</p>
										<p style="font-weight: 700;text-align: right;">914원</p>
									</div>
								</label>
							</div>
						</li>
					</ul>
				</div>
				<div class="paging">
					<div class="pagingWrap" id="drugs_paging">
						<!--처음-->

						<!--이전-->

						<!--페이지-->
						<a class="active" onclick="">1</a>

						<!--다음-->
						<a class="next disabled" onclick=""><i class="fa-light fa-chevron-right"></i></a>

						<!--마지막-->
						<a class="last disabled" onclick=""><i class="fa-light fa-chevrons-right"></i></a>
					</div>
				</div>
            </div>

        </section>
        <section id="simple">
            <h6>주문하기
                <button type="button" class="btn" id="listOpen2">접기</button>
            </h6>

            <div>
				<div class="flex gap10">

					<button type="button" class="btn btn_large btn_blue" onclick="medicinalSearchPopup()"><i class="fa-solid fa-cart-plus"></i> 신규약 담기</button>
					<button type="button" class="btn btn_large btn_green"><i class="fa-solid fa-bags-shopping"></i> 주문하기</button>
				</div>
                <div class="drugs_list">
                    <ul id="drugs_list">
						<li>
							<div class="flex">
								<button type="button" class="delete"><i class="fa-solid fa-x"></i></button>
								<input type="checkbox" name="checkIdx" id="checkIdx" value="" class="" onclick="checkboxes_func2()" checked disabled>
								<label for="checkIdx">
									<div>
										<p class="p_name">
											라식스주사20mg/2ml
										</p>
										<span>제조사 <strong>제조사</strong> |</span>
										<span>단위 <strong>단위</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>성분명</strong> |</span>
										<span>재고수량  <strong>0</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price">17,450원</p>
									</div>
								</label>
							</div>
							<div class="more" data-toggle="modal" data-target="#moreModal1" onclick="callContent_cons(1,'163830BIJ','라식스주사20mg/2ml','17,450원')">
								<i class="fa-regular fa-arrow-turn-down-right"></i>
								<span><b>대체약</b>(1)</span>
							</div>
						</li>
						<li>
							<div class="flex">
								<button type="button" class="delete"><i class="fa-solid fa-x"></i></button>
								<input type="checkbox" name="checkIdx" id="checkIdx2" value="" class="" onclick="checkboxes_func2()" checked disabled>
								<label for="checkIdx2">
									<div>
										<p class="p_name">
											라노펜정325mg                                            </p>
										<span>제조사 <strong>한국코러스(주)</strong> |</span>
										<span>단위 <strong>30T</strong> |</span><br class="visible-xs">
										<span>성분명 <strong>acetaminophen   0.325g</strong> |</span>
										<span>재고수량  <strong>63</strong></span>
									</div>
									<div class="area_text">
										<p class="p_price">4,530원</p>
									</div>
								</label>
							</div>
							<div class="more" data-toggle="modal" data-target="#moreModal1" onclick="callContent_cons(1,'513000ATB','라노펜정325mg','4,530원')">
								<i class="fa-regular fa-arrow-turn-down-right"></i>
								<span><b>대체약</b>(1)</span>
							</div>
						</li>
						<li class="empty">

							<p>담은 상품이 없습니다.</p>
						</li>
                    </ul>
                </div>

                <div class="paging">
                    <div class="pagingWrap" id="drugs_paging">
                        <!--처음-->
                        <?php if ($paging['page'] > 1 && $paging['totalPage'] > 0) { ?>
                            <a class="first disabled" onclick="callContent(1)"><i class="fa-light fa-chevrons-left"></i></a>
                        <?php } ?>

                        <!--이전-->
                        <?php if ($paging['currentBlock'] > 1) { ?>
                            <a class="prev disabled" onclick="callContent(<?= $paging['startPage'] - 1 ?>)"><i
                                        class="fa-light fa-chevron-left"></i></a>
                        <?php } ?>

                        <!--페이지-->
                        <?php
                        if ($paging['totalPage'] != 0) {
                            foreach (range(1, $paging['totalPage']) as $number) {
                                if ($number >= $paging['startPage'] && $number <= $paging['endPage']) {
                                    $action = "?page=" . $number . "&" . $qstr;
                                    if ($paging['page'] == $number) $action = "javascript:void(0)";
                                    ?>
                                    <a class="<?= ($paging['page'] == $number) ? 'active' : '' ?>"
                                       onclick="callContent(<?= $number ?>)"><?= $number ?></a>
                                <?php }
                            }
                        } ?>

                        <!--다음-->
                        <?php if ($paging['totalBlock'] > 1 && $paging['totalBlock'] != $paging['currentBlock']) { ?>
                            <a class="next disabled" onclick="callContent(<?= $paging['endPage'] + 1 ?>)"><i
                                        class="fa-light fa-chevron-right"></i></a>
                        <?php } ?>

                        <!--마지막-->
                        <?php if ($paging['page'] < $paging['totalPage']) { ?>
                            <a class="last disabled" onclick="callContent(<?= $paging['totalPage'] + 1 ?>)"><i
                                        class="fa-light fa-chevrons-right"></i></a>
                        <?php } ?>
                    </div id="drugs_paging_end">
                </div>
            </div>
        </section>
    </div>


</section>

<!-- 동일성분약품 Modal -->
<div class="modal fade more_modal" id="moreModal1" tabindex="-1" aria-labelledby="moreModal1Label" aria-hidden="true">
    <div class="modal-dialog wide">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="drugs_list_cons_modal">
                <div class="box">
                    <p class="txt_bold txt_blue">선택 의약품</p>
                    <div class="flex jc-sb basic">
                        <div>
                            <p class="p_name">레바미피드 100mg</p>
                        </div>
                        <div class="area_text">
                            <p class="p_price">40,000원</p>
                        </div>
                    </div>
                </div>
                <div class="search">
                    <input type="search" name="hstx" id="" placeholder="원하시는 제품을 검색하세요" value=""/>
                    <button type="button" class="btn" onclick=""><i class="fa-regular fa-magnifying-glass"></i></button>
                </div>

                <p class="txt_bold txt_blue">대체약</p>
                <ul class="drugs_list">
                    <li>
                        <div class="flex">
                            <input type="checkbox" name="" id="more1" value="5">
                            <label for="more1">
                                <div>
                                    <p class="p_name">레바미피드 100mg</p>
                                    <span>제조사 <strong>구매문의</strong> |</span>
                                    <span>단위 <strong>500T</strong> |</span>
                                    <span>대체약  <strong>무코스타</strong></span>
                                </div>
                                <div class="area_text">
                                    <p class="p_price">40,000원</p>
                                </div>
                            </label>
                        </div>
                    </li>

                </ul>
                <div class="paging">
                    <div class="pagingWrap">
                        <!--처음-->

                        <!--이전-->

                        <!--페이지-->
                        <a class="active" href="javascript:void(0)">1</a>
                        <a class="" onclick="callContent()" href="?page=2&amp;">2</a>
                        <a class="" href="?page=3&amp;">3</a>
                        <a class="" href="?page=4&amp;">4</a>
                        <a class="" href="?page=5&amp;">5</a>

                        <!--다음-->
                        <a class="next disabled" href="?page=11&amp;"><i class="fa-light fa-chevron-right"></i></a>

                        <!--마지막-->
                        <a class="last disabled" href="?page=101&amp;"><i class="fa-light fa-chevrons-right"></i></a>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <!--
				<button type="button" class="btn btn_middle btn_gray" data-dismiss="modal">닫기</button>
				-->
                <button type="button" class="btn btn_middle btn_blue" data-dismiss="modal">선택 완료</button>
            </div>
        </div>
    </div>
</div>
<form name="order" autocomplete="off" method="post">
    <input type="hidden" name="productIdx" value=""/> <!--상품인덱스-->
    <input type="hidden" name="productCnt" value=""/> <!--구매수량-->
    <input type="hidden" name="totalPrice" value=""/> <!--총상품금액-->
</form>

<script>
    let a1 = document.querySelector('#listOpen1');
    a1.addEventListener('click', function () {
        if (a1.classList.contains('on')) {
            a1.classList.remove('on');
            a1.innerText = "접기";
        } else {
            a1.classList.add('on');
            a1.innerText = "열기";
        }
    });

    let b1 = document.querySelector('#listOpen2');
    b1.addEventListener('click', function () {
        if (b1.classList.contains('on')) {
            b1.classList.remove('on');
            b1.innerText = "접기";
        } else {
            b1.classList.add('on');
            b1.innerText = "열기";
        }
    });
	function medicinalSearchPopup() {
		window.open("../medicinalSearch", "popupWindow", "width=600, height=800, scrollbars=no");
	}
</script>

<script>
    const searchFrm = document.searchFrm; // 검색 폼
    var page = <?=$paging['page']?>; // 페이지
    var hstx = '<?=$_GET['hstx']?>'; // 검색어
    var initial = '<?=$_GET['initial']?>'; // 초성

    $(function () {
        // 목록 정렬
        const orderElements = document.querySelectorAll('.sort li a');
        orderElements.forEach((elem) => {
            elem.addEventListener('click', async () => {
                searchFilter("order", elem.classList[0]);
            });
        });
        if ('<?=$_GET['order']?>' != '') {
            orderElements.forEach((elem) => {
                elem.classList.remove('active');
                if (elem.classList.contains('<?=$_GET['order']?>')) elem.classList.add('active');
            });
        }

        // 초성 검색
        const initialRadios = document.querySelectorAll('input[name="initial"]');
        initialRadios.forEach(radio => {
            radio.addEventListener('click', async (e) => {

                if (e.target.value) {
                    callContent(1, 0, e.target.value);
                } else {
                    //전체 선택하면 검색어 풀리게
                    $('#drugs_hstx').val('');
                    callContent(1, 0, e.target.value);
                }

                //searchFilter("initial", e.target.value);
            });
        });
        if ('<?=$_GET['initial']?>' != '') {
            searchFrm.initial.value = '<?=$_GET['initial']?>';
        }
    });

    // 검색 필터
    const searchFilter = (filter, value) => {
        searchFrm[filter].value = value;
        searchFrm.submit();
    }

    // 상품 선택 시
    var idxArr = [];

    async function checkboxes_func2(checkbox) {
        // 일시품절 체크
        if (checkbox.parentElement.querySelector('.soldout')) {
            return showAlert('임시품절 된 상품입니다.', () => {
                checkbox.checked = false;
            });
        }
        //console.log(checkbox);
        // 상품 정보
        const response = await fetchData(`/api/getProductInfo/${checkbox.value}`, '', 'GET');
        console.log(response);
        if(response.result == false){
            idxArr = idxArr.filter((element) => element !== response.idx);
            $("." + checkbox.value + "").prop("checked", false); // class로 체크다해주기
            showAlert('상품 오류');
            return false;
        }
        if ($.inArray(checkbox.value, idxArr) != -1 && checkbox.checked) {
            //배열에 해당값 있음
            changeCount(checkbox.value, 1);
            return false;
        } else if ($.inArray(checkbox.value, idxArr) == -1 && checkbox.checked) {
            //배열에 해당값없음
            idxArr.push(checkbox.value);
        } else {
            // 체크해제시
            document.querySelector(`.liProducts .li${response.idx}`).remove();
            $("." + response.idx + "").prop("checked", false); // class로 체크다해주기
            idxArr = idxArr.filter((element) => element !== response.idx);
            calcTotalPrice();
            return false;
        }

        //보험가 적용하는 회원들 따로 가격
        <?php if ($member['INSU_CHECK'] == 'Y') { ?>
        //회원가인사람들 0원이면 제품문의띄워주고 idx빼줌
        if(Math.floor(response.INSU_PRICE) == 0){
            idxArr = idxArr.filter((element) => element !== response.idx);
            $("." + checkbox.value + "").prop("checked", false); // class로 체크다해주기
            showAlert('해당 제품은 문의 바랍니다.');
            return false;
        }else{

        }
        <?php }else{ ?>
        //회원가인사람들 0원이면 제품문의띄워주고 idx빼줌
        if(Math.floor(response.prod_price) == 0){
            idxArr = idxArr.filter((element) => element !== response.idx);
            $("." + checkbox.value + "").prop("checked", false); // class로 체크다해주기
            showAlert('해당 제품은 문의 바랍니다.');
            return false;
        }else{

        }
        <?php } ?>

        if (checkbox.checked) {
            $("." + checkbox.value + "").prop("checked", true); // class로 체크다해주기
        } else {
            $("." + checkbox.value + "").prop("checked", false); // class로 체크다해주기
        }

        document.querySelector('[name=productIdx]').value = idxArr; // formdata 상품인덱스

        console.log(idxArr);
        var html = `
                <li id="li${response.idx}" class="li${response.idx}">
                    <p class="p_name">${response.PRODUCT_NM}</p>
                    <p class="p_unit">${response.PRODUCT_STANDARD} | ${response.PRODUCT_UNIT}</p>
`;
        //보험가 적용하는 회원들 따로 가격
        <?php if ($member['INSU_CHECK'] == 'Y') { ?>
        html += `<p class="p_price">${addCommaNumber(Math.floor(removeComma(response.INSU_PRICE)))}원</p>`
        <?php }else{ ?>
        html += `<p class="p_price">${addCommaNumber(Math.floor(removeComma(response.prod_price)))}원</p>`
        <?php } ?>

        html += `
                    <div class="number_controller">
                        <button type="button" onclick="changeCount(${response.idx}, -1)"><i class="fa-regular fa-minus"></i></button>
                        <input type="number" name="inputNumber" value="1" onkeyup="this.value=numberChk(this.value);changeCount(${response.idx}, this.value, true)" id="inputNumber${response.idx}"/>
                        <button type="button" onclick="changeCount(${response.idx}, 1)" id="Count_add${response.idx}"><i class="fa-regular fa-plus"></i></button>
                    </div>
                    `;

        //보험가 적용하는 회원들 따로 가격
        <?php if ($member['INSU_CHECK'] == 'Y') { ?>
        html += `<p class="p_price2"><span class="prodPriceDisplay">${addCommaNumber(Math.floor(removeComma(response.INSU_PRICE)))}</span>원</p>`;
        <?php }else{ ?>
        html += `<p class="p_price2"><span class="prodPriceDisplay">${addCommaNumber(Math.floor(removeComma(response.prod_price)))}</span>원</p>`;
        <?php } ?>

        html += `
                    <a><i class="fa-light fa-close" onclick="delProduct(${response.idx})"></i></a>
                </li>
        `;

        //console.log(html);
        //document.querySelector('.liProducts').innerHTML += html;
        $('.liProducts').append(html);

        // 스크롤 맨위로 되게
        const liProducts = document.querySelector('.liProducts'); // ul 리스트
        const lastLi = liProducts.lastElementChild; // 마지막 li 요소
        if (lastLi) {
            lastLi.scrollIntoView({ behavior: 'smooth' }); // 마지막 li로 스크롤
        }
        
        calcTotalPrice();
    }

    //시작과 동시에 실행
    //checkboxes_func();


    // 선택한 한방약품 삭제
    const delProduct = (idx) => {
        $("." + idx + "").prop("checked", false); // class로 체크다해주기
        idxArr = idxArr.filter((element) => element !== '' + idx + '');
        console.log(idxArr);
        document.querySelector(`.liProducts .li${idx}`).remove();
        calcTotalPrice();
    }

    // 구매수량 (버튼/입력)
    const changeCount = (id, value, input = false) => {

        const parent = $('#li' + id);
        console.log(parent);
        const numberElement = parent.find("input").val(); // 구매수량
        const price = toNumber(parent.children(`.p_price`).text()); // 상품금액

        // 변경수량
        let changeCount = !input ? toNumber(numberElement) + value : value;
        changeCount = Math.max(changeCount, 1);

        parent.find("input").val(changeCount);
        parent.find(`.prodPriceDisplay`).html(addCommaNumber(price * changeCount));

        console.log(changeCount);
        console.log(price * changeCount);

        calcTotalPrice();
    }

    // 총금액 계산
    const calcTotalPrice = () => {
        const list = document.querySelectorAll('.liProducts li');
        let productPrice = 0;

        const cntArr = [];
        if (list.length >= 1) {
            list.forEach(row => {
                const priceStr = row.querySelector('.prodPriceDisplay').innerText;
                const price = toNumber(priceStr);
                productPrice += price;

                cntArr.push(row.querySelector('[name=inputNumber]').value);
            });
        }

        document.querySelector('.totalPriceDisplay').innerHTML = addCommaNumber(productPrice); // 총 결제금액
        document.querySelector('[name=productCnt]').value = cntArr; // formdata 구매수량
        document.querySelector('[name=productIdx]').value = idxArr; // formdata 상품인덱스
    }

    // 장바구니 담기
    const addCart = async (isBuy = false) => {
        const list = document.querySelectorAll('.liProducts li');
        if (list.length == 0) return showAlert('약품을 선택해 주세요.');

        const form = document.order;
        const formData = new FormData(form);
        formData.append("isBuy", !isBuy ? 'Y' : 'N');

        const response = await fetchData(`/api/addCart`, formData);
        // console.log(response);

        if (response.result) {
            if (isBuy) { // 바로구매하기
                const cartIdxArr = response.cartIdx; //.split(',');
                if (cartIdxArr.length == 0) {
                    showAlert('서버와의 통신에 실패했습니다. 다시 시도해 주세요.', () => {
                        location.reload();
                    });
                    return false;
                }

                for (let i = 0; i < cartIdxArr.length; i++) {
                    let cartIdx = cartIdxArr[i];
                    let html = `<input type="hidden" name="cartIdx[]" value="${cartIdx}" />`;
                    form.insertAdjacentHTML('beforeend', html);
                }
                // 주문서 이동
                form.action = baseUrl + 'orderSheet';
                form.submit();

            } else { // 장바구니등록
                const confirmResult = await showConfirm('장바구니에 추가되었습니다.<br>장바구니로 이동하시겠습니까?');
                if (confirmResult.isConfirmed !== true) return false;
                else {
                    location.href = baseUrl + 'cart';
                }
            }

            document.querySelectorAll('input[name="checkIdx"]').forEach((checkbox) => {
                checkbox.checked = false;
            });
        } else {
            showAlert('서버와의 통신에 실패했습니다. 다시 시도해 주세요.', () => {
                location.reload();
            });
        }
    }


    const callContent = (page, hstx = '', initial = '') => {
        page = page;
        if (!initial) {
            initial = '<?=$_GET['initial']?>';
        }

        if (!hstx) {
            hstx = $('#drugs_hstx').val();
        }

        var url = baseUrl + "/medicinal/?hstx=" + hstx + "&initial=" + initial + "&page=" + page;
        var tbody = "";
        var thtml = "";
        var tbody2 = "";
        var thtml2 = "";
        console.log(url);
        $.ajax({
            type: "POST",
            url: url,
            dataType: "html",
            success: function (html) {
                tbody = html.split('<ul id="drugs_list">');
                thtml = tbody[1].split('</ul id="drugs_list_end">');

                tbody2 = html.split('<div class="pagingWrap" id="drugs_paging">');

                console.log(tbody2);

                thtml2 = tbody2[1].split('</div id="drugs_paging_end">');

                $("#drugs_list").html(thtml[0]);
                $("#drugs_paging").html(thtml2[0]);

                //이미 체크되어있는거 체크유지해주기
                $.each(idxArr, function (index, element) {
                    //console.log(index + " :: " + element);
                    $("." + element + "").prop("checked", true); // class로 체크다해주기
                });


            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    var CONS_CD = '';
    var PRODUCT_NM = '';
    var prod_price = '';

    const callContent_cons = (page, CONS_CD_get = '', PRODUCT_NM_get = '', prod_price_get = '', cons_hstx = '') => {

        //선택상품 성분명
        if (CONS_CD_get) {
            CONS_CD = CONS_CD_get;
        }

        //선택상품이름
        if (PRODUCT_NM_get) {
            PRODUCT_NM = PRODUCT_NM_get;
        }

        //선택상품금액
        if (prod_price_get) {
            prod_price = prod_price_get;
        }

        //검색어
        if (cons_hstx) {
            var cons_hstx = cons_hstx;
        }

        var url = baseUrl + "/medicinal_cons/?page=" + page + "&CONS_CD=" + CONS_CD + "&PRODUCT_NM=" + PRODUCT_NM + "&prod_price=" + prod_price + "&cons_hstx=" + cons_hstx;
        var tbody = "";

        console.log(url);
        $.ajax({
            type: "POST",
            url: url,
            dataType: "html",
            success: function (html) {

                tbody = html.split('<div class="box" id="drugs_list_cons">');
                thtml = tbody[1].split('</div id="drugs_list_cons_end">');

                $("#drugs_list_cons_modal").html(thtml[0]);

                //이미 체크되어있는거 체크유지해주기
                $.each(idxArr, function (index, element) {
                    //console.log(index + " :: " + element);
                    $("." + element + "").prop("checked", true); // class로 체크다해주기
                });

                //checkboxes_func();
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    const callContent_recent = (page, recent_hstx = '', drugs_recent_sdt = '', drugs_recent_edt = '') => {

        //검색어
        if (recent_hstx) {
            var recent_hstx = recent_hstx;
        }

        var sdt = '';
        if (drugs_recent_sdt) {
            sdt = drugs_recent_sdt;
        }

        var edt = '';
        if (drugs_recent_edt) {
            edt = drugs_recent_edt;
        }

        var url = baseUrl + "/medicinal_recent/?page=" + page + "&recent_hstx=" + recent_hstx + "&sdt=" + sdt + "&edt=" + edt;
        var tbody = "";

        console.log(url);
        $.ajax({
            type: "POST",
            url: url,
            dataType: "html",
            success: function (html) {

                tbody = html.split('<div class="flex js sub" id="drugs_list_recent">');
                thtml = tbody[1].split('</div id="drugs_list_recent_end">');

                $("#drugs_list_recent_modal").html(thtml[0]);

                //이미 체크되어있는거 체크유지해주기
                $.each(idxArr, function (index, element) {
                    //console.log(index + " :: " + element);
                    $("." + element + "").prop("checked", true); // class로 체크다해주기
                });

                //checkboxes_func();
            },
            error: function (xhr, status, error) {
                alert(error);
            }
        });
    }

    callContent_recent(1);
</script>
